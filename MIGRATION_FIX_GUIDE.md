# DEFINITIVE FIX: Database Migration Issues

## Problem Summary
- Alembic keeps trying to drop PostGIS Tiger Geocoder extension tables
- GeoAlchemy2 was auto-creating duplicate spatial indexes
- Migrations failing with "cannot drop table X because extension postgis_tiger_geocoder requires it"

## Solution

Follow these steps **on your local machine** in order:

---

### Step 1: Drop the Tiger Geocoder Extension

You don't need the Tiger Geocoder extension for the H5N1 app (it's only used for US street address geocoding). Drop it:

```bash
psql -U postgres -d bets_db
```

In psql, run:

```sql
-- Drop the problematic extension (keeps PostGIS itself)
DROP EXTENSION IF EXISTS postgis_tiger_geocoder CASCADE;

-- Verify PostGIS is still installed (you need this)
SELECT extname, extversion FROM pg_extension WHERE extname = 'postgis';

-- Should see: postgis | 3.x.x

\q
```

---

### Step 2: Clean Up Failed Migrations

```bash
cd /Users/tiffanybehrcore4ce/Documents/Work-Projects/Innovation_Challenge_25/backend

# Delete ALL migration files (keep env.py and script.py.mako)
rm alembic/versions/*.py

# Clear the alembic version tracking table
psql -U postgres -d bets_db -c "DELETE FROM alembic_version;"
```

---

### Step 3: Pull Latest Code with Fixed Models

```bash
cd /Users/tiffanybehrcore4ce/Documents/Work-Projects/Innovation_Challenge_25

# Pull the fixed models.py (with spatial_index=False)
git pull origin claude/analyze-ingestors-workflow-014f28oMJu3LAcdK9ygov51i
```

---

### Step 4: Update env.py to Import geoalchemy2

Add this import at the top of `backend/alembic/env.py` (after other imports):

```python
import geoalchemy2  # Required for autogenerate with Geometry columns
```

Your imports section should look like:

```python
import sys
from pathlib import Path
from logging.config import fileConfig

from sqlalchemy import engine_from_config
from sqlalchemy import pool
import geoalchemy2  # <-- ADD THIS

from src.utils.settings import settings
from alembic import context
```

---

### Step 5: Generate Fresh Migration

```bash
cd backend

# Generate new clean migration (no tiger tables will be included)
alembic revision --autogenerate -m "initial schema"

# Check the generated migration file - verify it does NOT contain:
# - op.drop_table('geocode_*')
# - op.drop_table('tiger_*')
# - op.drop_table('zip_*')
# - op.drop_table('loader_*')
```

---

### Step 6: Run Migration

```bash
alembic upgrade head
```

You should see:

```
[INFO] Environment: dev
INFO  [alembic.runtime.migration] Running upgrade  -> xxxxx, initial schema
```

**No errors!** âœ…

---

### Step 7: Verify Success

```bash
# Check tables were created
psql -U postgres -d bets_db -c "\dt"

# Should see:
# - h5n1_cases
# - alerts
# - data_imports
# - geographic_boundaries
# - users
# - alembic_version

# Check spatial indexes were created correctly
psql -U postgres -d bets_db -c "\di" | grep idx_spatial
```

---

## Why This Works

1. **Dropped Tiger Geocoder**: No more extension-owned tables trying to be dropped
2. **spatial_index=False**: Prevents GeoAlchemy2 from auto-creating duplicate indexes
3. **Clean slate**: Fresh migrations without corrupted history
4. **Import geoalchemy2**: Prevents NameError in autogenerated migrations

---

## After Success

Once migrations work, you can run the data ingestion:

```bash
python backend/scripts/run_ingestion.py --all
```

---

## If You Still Get Errors

If you see any remaining Tiger Geocoder table errors:

1. Check what tiger tables still exist:
   ```sql
   SELECT tablename FROM pg_tables WHERE tablename LIKE '%tiger%' OR tablename LIKE '%geocode%';
   ```

2. If any remain, drop them manually:
   ```sql
   DROP TABLE IF EXISTS <table_name> CASCADE;
   ```

3. Regenerate migration again
